<section id="user">
  <div class="container">
    <div class="row">
      <div class="col-sm-8 col-sm-offset-2">
        <h2><%= @user.name %></h2>
        <p><%= mail_to(@user.email) %></p>
        <p>Registered Since <%= @user.created_at.strftime("%B %Y") %></p>

        <%= render 'shared/admin_nav' %>
        <div class="data-view">
          <% if (@user.admin == true) %>
            <div class="admin-data">
              <h3>Location Data</h3>
              <form action="analytics" method="get" class="form-validate heatmap" role="search">
                <div class="input-group col-sm-5">
                  <span class="input-group-addon">Radius (km)</span>
                  <%= text_field_tag :radius, @radius_field, class: "form-control", required: false %>
                </div>

                <%= submit_tag "Apply filter", :name => nil, class: "btn btn-primary" %>
              </form>
              <div class="inset-gmap">
                <div id="analytics-map" style="height:600px;"></div>
              </div>
            </div>
          <% elsif (@user.facilities.count > 0) %>
            <% @user.facilities.each do |f| %>
              <h3><%= link_to f.name, facility_path(f.id) %></h3>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  var map, heatmap;

  function initMap() {
    var centerMap = {lat: 49.2776868, lng: -123.0980439}
    map = new google.maps.Map(document.getElementById('analytics-map'), {
      zoom: 13,
      center: centerMap,
      mapTypeId: 'satellite'
    });

    heatmap = new google.maps.visualization.HeatmapLayer({
      data: getPoints(),
      map: map
    });

    var cityCircle = new google.maps.Circle({
      strokeColor: '#FF0000',
      strokeOpacity: 0.8,
      strokeWeight: 2,
      fillColor: '#FF0000',
      fillOpacity: 0.15,
      map: map,
      center: centerMap,
      radius: <%= @radius %> // meters
    });
  }

  function getPoints() {
    return [
      <% @coordinates.each do |coord| %>
        {location: new google.maps.LatLng(<%= coord[0] %>, <%= coord[1] %>), weight: 1},
      <% end %>
    ];
  }
  google.maps.event.addDomListener(window, 'load', initialize);
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSLM-Bv5YwI1Ecw2OrMDQF8fZxik6FTzs&libraries=visualization&callback=initMap"></script>
